<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>í¬ê·€ ì•„ì´í…œ ë½‘ê¸°</title>

  <!-- Google Font + ê³ ê¸‰ CSS -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');
    body {
      margin: 0;
      font-family: 'Jua', sans-serif;
      background: linear-gradient(145deg, #202040, #543864);
      color: #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 30px;
      user-select: none;
    }

    h1 {
      font-size: 3rem;
      margin-bottom: 20px;
      text-shadow: 2px 2px 5px black;
    }

    button {
      font-size: 1.5rem;
      padding: 15px 40px;
      background: linear-gradient(to right, #43cea2, #185a9d);
      border: none;
      border-radius: 12px;
      color: white;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      transition: background 0.3s ease, transform 0.15s ease;
      margin: 5px;
    }
    button:hover {
      background: linear-gradient(to right, #6af2bc, #2a7dc5);
      transform: scale(1.05);
    }
    button:active {
      transform: scale(0.95);
    }

    button:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
    }

    #result {
      margin-top: 30px;
      font-size: 1.5rem;
      padding: 20px;
      background: rgba(255, 255, 255, 0.12);
      border-radius: 16px;
      max-width: 600px;
      word-break: break-word;
      text-align: center;
      box-shadow: 0 0 18px rgba(0,0,0,0.5);
      min-height: 3em;
      line-height: 1.4em;
    }
    #userStatus {
      margin-bottom: 15px;
      font-size: 1.3rem;
      min-height: 1.5em;
      color: #aaf;
    }
    #inventory {
      margin-top: 40px;
      max-width: 800px;
      width: 100%;
      background: rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 0 15px rgba(0,0,0,0.4);
      color: #eef;
    }
    #inventory h2 {
      margin-top: 0;
      text-align: center;
      text-shadow: 1px 1px 3px #0008;
    }
    #inventoryList {
      list-style: none;
      padding: 0;
      margin: 10px 0 20px 0;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #444;
      border-radius: 8px;
      background: #222244cc;
    }
    #inventoryList li {
      padding: 8px 12px;
      border-bottom: 1px solid #444;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 1rem;
      user-select: text;
    }
    #inventoryList li:last-child {
      border-bottom: none;
    }
    #inventoryList li.selected {
      background-color: rgba(67, 206, 162, 0.3);
    }
    
    .item-info {
      flex: 1;
      margin-right: 10px;
    }
    
    .item-buttons {
      display: flex;
      gap: 5px;
    }
    
    .item-buttons button {
      background: #d64545;
      padding: 6px 14px;
      font-size: 0.9rem;
      border-radius: 8px;
      box-shadow: none;
      transition: background 0.3s ease;
      cursor: pointer;
      margin: 0;
    }
    
    .item-buttons button:hover {
      background: #ff4f4f;
    }
    
    .item-buttons .select-btn {
      background: #43cea2;
    }
    
    .item-buttons .select-btn:hover {
      background: #6af2bc;
    }
    
    .item-buttons .select-btn.selected {
      background: #ff8800;
    }
    
    .item-buttons .select-btn.selected:hover {
      background: #ffaa00;
    }

    #totalMoney {
      font-weight: bold;
      font-size: 1.3rem;
      text-align: center;
      margin-top: 10px;
      text-shadow: 1px 1px 2px #0008;
    }
    
    #combineSection {
      margin-top: 20px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      border: 2px solid #43cea2;
    }
    
    #combineSection h3 {
      margin-top: 0;
      color: #43cea2;
      text-align: center;
    }
    
    #selectedItems {
      margin: 15px 0;
      font-size: 1.1rem;
      min-height: 40px;
    }
    
    .combine-button {
      background: linear-gradient(to right, #ff6b35, #f7931e) !important;
      font-size: 1.2rem !important;
      padding: 12px 30px !important;
    }
    
    .combine-button:hover {
      background: linear-gradient(to right, #ff8555, #ffaa3e) !important;
    }
    
    .enhancement-great { color: #90EE90; }
    .enhancement-super { color: #87CEEB; }
    .enhancement-mega { color: #DDA0DD; }
    .enhancement-ultra { color: #FFD700; }
    .enhancement-secret { color: #FF69B4; }
    .enhancement-ultimate { color: #FF4500; text-shadow: 0 0 10px #FF4500; }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body>

  <h1>í¬ê·€ ì•„ì´í…œ ë½‘ê¸°</h1>
  <h1>(Made by ë²”ì„œ)</h1>
  <h1>Ver. 2.0 - í•©ì„± ì‹œìŠ¤í…œ</h1>
  <div id="userStatus">ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...</div>
  <div>
    <button id="loginBtn">Google ë¡œê·¸ì¸</button>
    <button id="logoutBtn" style="display:none;">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
  <button id="drawBtn" disabled>ë½‘ê¸°í•˜ê¸°</button>
  <div id="result">ì•„ì´í…œì„ ë½‘ì•„ë³´ì„¸ìš”!</div>

  <section id="inventory" style="display:none;">
    <h2>ì¸ë²¤í† ë¦¬</h2>
    <ul id="inventoryList"></ul>
    <div id="totalMoney">ë³´ìœ  ê¸ˆì•¡: 0 ê³¨ë“œ</div>
    
    <div id="combineSection">
      <h3>ì•„ì´í…œ í•©ì„±</h3>
      <p>ê°™ì€ ë“±ê¸‰ì˜ ì•„ì´í…œ 2ê°œë¥¼ ì„ íƒí•˜ì—¬ í•©ì„±í•˜ì„¸ìš”!</p>
      <div id="selectedItems">ì„ íƒëœ ì•„ì´í…œ: ì—†ìŒ</div>
      <button id="combineBtn" class="combine-button" disabled>í•©ì„±í•˜ê¸°</button>
      <button id="clearSelection" style="background: #888; font-size: 1rem; padding: 8px 16px;">ì„ íƒ ì´ˆê¸°í™”</button>
    </div>
    <button id="marketBtn">ê±°ë˜ì¥</button>

<!-- ê±°ë˜ì¥ í˜ì´ì§€ -->
<div id="marketPage" style="display:none;">
  <h2>ğŸ“ˆ ì£¼ì‹ì¥</h2>
  
  <!-- ê²€ìƒ‰ -->
  <input type="text" id="marketSearch" placeholder="ì•„ì´í…œ ê²€ìƒ‰...">

  <!-- í•„í„° -->
  <div>
    <label><input type="checkbox" id="filterPrefix"> ì ‘ë‘ì‚¬ ìˆìŒ</label>
    <label><input type="checkbox" id="filterRarity"> í¬ê·€ë„ ë†’ì€ìˆœ</label>
    <label><input type="checkbox" id="filterEnhancement"> í•©ì„± ë“±ê¸‰ ë†’ì€ìˆœ</label>
  </div>

  <!-- ë‚´ ìƒí’ˆ -->
  <h3>ë‚´ ìƒí’ˆ</h3>
  <div id="myListings"></div>

  <!-- ë“±ë¡ ê°€ëŠ¥í•œ ì¸ë²¤í† ë¦¬ -->
  <h3>ë“±ë¡í•˜ê¸°</h3>
  <div id="inventoryForMarket"></div>

  <!-- ì „ì²´ ì‹œì¥ ìƒí’ˆ -->
  <h3>ì‹œì¥ ìƒí’ˆ</h3>
  <div id="marketListings"></div>
</div>
  </section>

  <script>
    // Firebase ì„¤ì • ë° ì´ˆê¸°í™”
    const firebaseConfig = {
      apiKey: "AIzaSyDugT2jmkz5SHMXmOE1IRnkooqoK-1ezXQ",
      authDomain: "raregacha-c22c7.firebaseapp.com",
      projectId: "raregacha-c22c7",
      storageBucket: "raregacha-c22c7.firebasestorage.app",
      messagingSenderId: "271926804314",
      appId: "1:271926804314:web:96cd484461a2305e863d63",
      measurementId: "G-GJPLSJBLJD"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // DOM ìš”ì†Œ
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const userStatus = document.getElementById("userStatus");
    const drawBtn = document.getElementById("drawBtn");
    const inventorySection = document.getElementById("inventory");
    const inventoryList = document.getElementById("inventoryList");
    const totalMoneyElem = document.getElementById("totalMoney");
    const combineBtn = document.getElementById("combineBtn");
    const selectedItemsElem = document.getElementById("selectedItems");
    const clearSelectionBtn = document.getElementById("clearSelection");

const items = [
  // C ë“±ê¸‰ (48ê°œ)
  { name: "ì—°í•„", rarity: "C" },
  { name: "ë³¼íœ", rarity: "C" },
  { name: "ì§€ìš°ê°œ", rarity: "C" },
  { name: "ìƒ¤í”„", rarity: "C" },
  { name: "A4ìš©ì§€", rarity: "C" },
  { name: "í¬ìŠ¤íŠ¸ì‡", rarity: "C" },
  { name: "ë…¸íŠ¸", rarity: "C" },
  { name: "ì¼íšŒìš© ì»µ", rarity: "C" },
  { name: "ë¹¨ëŒ€", rarity: "C" },
  { name: "ì¼íšŒìš© ìˆŸê°€ë½", rarity: "C" },
  { name: "ì¢…ì´ì ‘ì‹œ", rarity: "C" },
  { name: "ë¹„ë‹ë´‰ì§€", rarity: "C" },
  { name: "íœ´ì§€", rarity: "C" },
  { name: "ë§ˆìŠ¤í¬", rarity: "C" },
  { name: "ì»¤í„°ì¹¼", rarity: "C" },
  { name: "ë¶„í•„", rarity: "C" },
  { name: "ì—°ìŠµì¥", rarity: "C" },
  { name: "ì", rarity: "C" },
  { name: "í…Œì´í”„", rarity: "C" },
  { name: "ë¬¼í‹°ìŠˆ", rarity: "C" },
  { name: "ê±´ì „ì§€", rarity: "C" },
  { name: "ì†í†±ê¹ì´", rarity: "C" },
  { name: "ì—´ì‡ ê³ ë¦¬", rarity: "C" },
  { name: "ë©”ëª¨ì¥", rarity: "C" },
  { name: "ë„ì¥", rarity: "C" },
  { name: "ìŠ¤í‹°ì»¤", rarity: "C" },
  { name: "í´ë¦½", rarity: "C" },
  { name: "íŒŒì¼", rarity: "C" },
  { name: "ì±…ê°ˆí”¼", rarity: "C" },
  { name: "ë¨¸ë¦¬ëˆ", rarity: "C" },
  { name: "ì†ìˆ˜ê±´", rarity: "C" },
  { name: "ì–‘ë§", rarity: "C" },
  { name: "í‹°ì…”ì¸ ", rarity: "C" },
  { name: "ìš°ì‚° ì¼€ì´ìŠ¤", rarity: "C" },
  { name: "ìì „ê±° ë²¨", rarity: "C" },
  { name: "íœ´ëŒ€í° ê±°ì¹˜ëŒ€", rarity: "C" },
  { name: "ì¶©ì „ ì¼€ì´ë¸”", rarity: "C" },
  { name: "USB", rarity: "C" },
  { name: "ì—ì–´ì»¨ ë¦¬ëª¨ì»¨", rarity: "C" },
  { name: "ì…€í”„ íƒ€ì´ë¨¸", rarity: "C" },
  { name: "ëƒ‰ì¥ê³  ìì„", rarity: "C" },
  { name: "ìŠ¤í€ì§€", rarity: "C" },
  { name: "ìˆ˜ì„¸ë¯¸", rarity: "C" },
  { name: "ì˜·ê±¸ì´", rarity: "C" },
  { name: "ì‹íƒë³´", rarity: "C" },
  { name: "í™”ë¶„ ë°›ì¹¨", rarity: "C" },
  { name: "ì¡°í™”", rarity: "C" },
  { name: "ì†Œí˜• ì“°ë ˆê¸°í†µ", rarity: "C" },

  // B ë“±ê¸‰ (36ê°œ)
  { name: "ë¨¸ê·¸ì»µ", rarity: "B" },
  { name: "í…€ë¸”ëŸ¬", rarity: "B" },
  { name: "ìš°ì‚°", rarity: "B" },
  { name: "ë‹¤ì´ì–´ë¦¬", rarity: "B" },
  { name: "ê³ ê¸‰ ë³¼íœ", rarity: "B" },
  { name: "íœ´ëŒ€ìš© ê±°ìš¸", rarity: "B" },
  { name: "ì†ëª©ì‹œê³„", rarity: "B" },
  { name: "í—¤ë“œì…‹", rarity: "B" },
  { name: "ë³´ì¡°ë°°í„°ë¦¬", rarity: "B" },
  { name: "ê³ ì† ì¶©ì „ê¸°", rarity: "B" },
  { name: "ìŠ¤ë§ˆíŠ¸í° ì¼€ì´ìŠ¤", rarity: "B" },
  { name: "ë¨í”„", rarity: "B" },
  { name: "ì•ŒëŒì‹œê³„", rarity: "B" },
  { name: "ìº í•‘ì˜ì", rarity: "B" },
  { name: "ë¯¸ë‹ˆ ê°€ìŠµê¸°", rarity: "B" },
  { name: "ë¬´ì„  ë§ˆìš°ìŠ¤", rarity: "B" },
  { name: "í‚¤ë³´ë“œ", rarity: "B" },
  { name: "ì±…ìƒ ìŠ¤íƒ ë“œ", rarity: "B" },
  { name: "ë©€í‹°íƒ­", rarity: "B" },
  { name: "íœ´ëŒ€ìš© ì†ë‚œë¡œ", rarity: "B" },
  { name: "ë¯¸ë‹ˆ ì„ í’ê¸°", rarity: "B" },
  { name: "ì½”ë“œ ì •ë¦¬ê¸°", rarity: "B" },
  { name: "ê±°ì¹˜ëŒ€ ìŠ¤íƒ ë“œ", rarity: "B" },
  { name: "íœ´ëŒ€ìš© ì„¸ë©´ë„êµ¬ í‚¤íŠ¸", rarity: "B" },
  { name: "ì²œì—° ë¹„ëˆ„", rarity: "B" },
  { name: "ì†Œí˜• ìŠ¤í”¼ì»¤", rarity: "B" },
  { name: "ì•„ì´íŒ¨ë“œ íœìŠ¬", rarity: "B" },
  { name: "ì™€ì´íŒŒì´ ê³µìœ ê¸°", rarity: "B" },
  { name: "ë¸”ë£¨ë¼ì´íŠ¸ ì°¨ë‹¨ ì•ˆê²½", rarity: "B" },
  { name: "ë…ì„œëŒ€", rarity: "B" },
  { name: "ëª¨ë‹ˆí„° ë°›ì¹¨ëŒ€", rarity: "B" },
  { name: "ì „ìì‹œê³„", rarity: "B" },
  { name: "ìœ ì„  ì´ì–´í°", rarity: "B" },
  { name: "ì¡°ëª… ê±°ìš¸", rarity: "B" },
  { name: "í•€ ë§ˆì´í¬", rarity: "B" },
  { name: "ë¼ë²¨ í”„ë¦°í„°", rarity: "B" },

  // A ë“±ê¸‰ (18ê°œ)
  { name: "ë¬´ì„  ì´ì–´í°", rarity: "A" },
  { name: "í¬í„°ë¸” ìŠ¤í”¼ì»¤", rarity: "A" },
  { name: "ìŠ¤íƒ ë”© ë°ìŠ¤í¬", rarity: "A" },
  { name: "ë¸”ë£¨íˆ¬ìŠ¤ í‚¤ë³´ë“œ", rarity: "A" },
  { name: "ìŠ¬ë¦¼ ë©íƒ‘ ê±°ì¹˜ëŒ€", rarity: "A" },
  { name: "ìŠ¤ë§ˆíŠ¸ ì²´ì¤‘ê³„", rarity: "A" },
  { name: "ë¬´ë“œë“±", rarity: "A" },
  { name: "ë¯¸ë‹ˆ ê³µê¸°ì²­ì •ê¸°", rarity: "A" },
  { name: "ë¬´ì„  í”„ë¦°í„°", rarity: "A" },
  { name: "íƒœë¸”ë¦¿ ê±°ì¹˜ëŒ€", rarity: "A" },
  { name: "ì „ì ë©”ëª¨íŒ¨ë“œ", rarity: "A" },
  { name: "ë¯¸ë‹ˆë¹” í”„ë¡œì í„°", rarity: "A" },
  { name: "íœ´ëŒ€ìš© ë³´í’€ì œê±°ê¸°", rarity: "A" },
  { name: "ë©€í‹° ì¶©ì „ ë…", rarity: "A" },
  { name: "ë””ì§€í„¸ ì•¡ì", rarity: "A" },
  { name: "LED ì•ŒëŒì‹œê³„", rarity: "A" },
  { name: "ì•„ì´í° ë¼ì´íŠ¸ë‹ ì˜¤ë””ì˜¤ì­", rarity: "A" },
  { name: "ìë™ ì„¼ì„œ íœ´ì§€í†µ", rarity: "A" },

  // S ë“±ê¸‰ (12ê°œ)
  { name: "ìŠ¤ë§ˆíŠ¸ì›Œì¹˜", rarity: "S" },
  { name: "íƒœë¸”ë¦¿", rarity: "S" },
  { name: "ë“œë¡ ", rarity: "S" },
  { name: "ê³ ê¸‰ ì»¤í”¼ë¨¸ì‹ ", rarity: "S" },
  { name: "ë¬´ì„  ê³ ê¸‰ ì²­ì†Œê¸°", rarity: "S" },
  { name: "í•˜ì´ì—”ë“œ í—¤ë“œí°", rarity: "S" },
  { name: "íœ´ëŒ€ìš© í”„ë¡œì í„°", rarity: "S" },
  { name: "ìŠ¤ë§ˆíŠ¸ ë¯¸ëŸ¬", rarity: "S" },
  { name: "ë¯¸ëŸ¬ë¦¬ìŠ¤ ì¹´ë©”ë¼", rarity: "S" },
  { name: "ì›Œí„°í•„í„° ì •ìˆ˜ê¸°", rarity: "S" },
  { name: "AI ìŒì„± ìŠ¤í”¼ì»¤", rarity: "S" },
  { name: "í”„ë¦¬ë¯¸ì—„ ëª¨ë‹ˆí„°", rarity: "S" },

  // UR ë“±ê¸‰ (6ê°œ)
  { name: "ë¸”ë£¨íˆ¬ìŠ¤ ìƒ¤ì›Œê¸°", rarity: "UR" },
  { name: "ë°”ë³´ìƒì", rarity: "UR" },
  { name: "ë”¥ëŸ¬ë‹ AI ì³‡ë´‡", rarity: "UR" },
  { name: "í”„ë¦¬ë¯¸ì—„ ì´ˆì½œë¦¿ ë©”ì´ì»¤", rarity: "UR" },
  { name: "ì² ì œë ¨ìš© ìš©ì ‘ê¸°ê³„", rarity: "UR" },
  { name: "ê°„ì´ ì—˜ë¦¬ë² ì´í„°", rarity: "UR" },
];

    // í™•ë¥  ë° ê°€ê²© ì„¤ì •
    const rarityRates = {
      C: 0.4, B: 0.3, A: 0.15, S: 0.1, UR: 0.05
    };
    
    // ê¸°ë³¸ íŒë§¤ ê°€ê²© (20ì› ê¸°ì¤€)
    const rarityPrices = {
      C: 20, B: 40, A: 60, S: 80, UR: 100
    };
    
    // í•©ì„± ë“±ê¸‰ í™•ë¥ 
    const enhancementRates = {
      normal: { great: 0.65, super: 0.17, mega: 0.10, ultra: 0.06, secret: 0.015, ultimate: 0.005 },
      prefix: { super: 0.70, mega: 0.17, ultra: 0.09, secret: 0.03, ultimate: 0.01 }
    };
    
    // í•©ì„± ë“±ê¸‰ ë°°ìœ¨
    const enhancementMultipliers = {
      great: 1.1,
      super: 2,
      mega: 36,
      ultra: 100,
      secret: 1000,
      ultimate: 6999
    };

    // ì „ì—­ ë³€ìˆ˜
    let pullCount = parseInt(localStorage.getItem("pullCount") || "0");
    let lastDrawTime = parseInt(localStorage.getItem("lastDrawTime") || "0");
    if (!lastDrawTime) lastDrawTime = 0;
    let totalMoney = parseInt(localStorage.getItem("totalMoney") || "0");
    let inventory = JSON.parse(localStorage.getItem("inventory") || "[]");
    let screenStartTime = Date.now();
    let selectedItems = [];

    // ì ‘ë‘ì‚¬ ì¡°ê±´
    const prefixConditions = [
      // ì´ˆ ë‹¨ìœ„
      { prefix: "5ì´ˆì˜ ", condition: ctx => ctx.seconds === 5 },
      { prefix: "15ì´ˆì˜ ", condition: ctx => ctx.seconds === 15 },
      { prefix: "20ì´ˆì˜ ", condition: ctx => ctx.seconds === 20 },
      { prefix: "25ì´ˆì˜ ", condition: ctx => ctx.seconds === 25 },
      { prefix: "30ì´ˆì˜ ", condition: ctx => ctx.seconds === 30 },
      { prefix: "35ì´ˆì˜ ", condition: ctx => ctx.seconds === 35 },
      { prefix: "40ì´ˆì˜ ", condition: ctx => ctx.seconds === 40 },
      { prefix: "45ì´ˆì˜ ", condition: ctx => ctx.seconds === 45 },
      { prefix: "50ì´ˆì˜ ", condition: ctx => ctx.seconds === 50 },
      { prefix: "55ì´ˆì˜ ", condition: ctx => ctx.seconds === 55 },

      // ë¶„ ë‹¨ìœ„
      { prefix: "10ë¶„ì˜ ", condition: ctx => ctx.minute === 10 },
      { prefix: "15ë¶„ì˜ ", condition: ctx => ctx.minute === 15 },
      { prefix: "20ë¶„ì˜ ", condition: ctx => ctx.minute === 20 },
      { prefix: "30ë¶„ì˜ ", condition: ctx => ctx.minute === 30 },
      { prefix: "35ë¶„ì˜ ", condition: ctx => ctx.minute === 35 },
      { prefix: "45ë¶„ì˜ ", condition: ctx => ctx.minute === 45 },
      { prefix: "50ë¶„ì˜ ", condition: ctx => ctx.minute === 50 },

      // ì‹œ ë‹¨ìœ„
      { prefix: "0ì‹œì˜ ", condition: ctx => ctx.hour === 0 },
      { prefix: "1ì‹œì˜ ", condition: ctx => ctx.hour === 1 },
      { prefix: "2ì‹œì˜ ", condition: ctx => ctx.hour === 2 },
      { prefix: "3ì‹œì˜ ", condition: ctx => ctx.hour === 3 },
      { prefix: "5ì‹œì˜ ", condition: ctx => ctx.hour === 5 },
      { prefix: "6ì‹œì˜ ", condition: ctx => ctx.hour === 6 },
      { prefix: "7ì‹œì˜ ", condition: ctx => ctx.hour === 7 },
      { prefix: "8ì‹œì˜ ", condition: ctx => ctx.hour === 8 },
      { prefix: "9ì‹œì˜ ", condition: ctx => ctx.hour === 9 },
      { prefix: "10ì‹œì˜ ", condition: ctx => ctx.hour === 10 },
      { prefix: "11ì‹œì˜ ", condition: ctx => ctx.hour === 11 },
      { prefix: "12ì‹œì˜ ", condition: ctx => ctx.hour === 12 },
      { prefix: "13ì‹œì˜ ", condition: ctx => ctx.hour === 13 },
      { prefix: "14ì‹œì˜ ", condition: ctx => ctx.hour === 14 },
      { prefix: "15ì‹œì˜ ", condition: ctx => ctx.hour === 15 },
      { prefix: "16ì‹œì˜ ", condition: ctx => ctx.hour === 16 },
      { prefix: "17ì‹œì˜ ", condition: ctx => ctx.hour === 17 },
      { prefix: "18ì‹œì˜ ", condition: ctx => ctx.hour === 18 },
      { prefix: "19ì‹œì˜ ", condition: ctx => ctx.hour === 19 },
      { prefix: "20ì‹œì˜ ", condition: ctx => ctx.hour === 20 },
      { prefix: "21ì‹œì˜ ", condition: ctx => ctx.hour === 21 },
      { prefix: "22ì‹œì˜ ", condition: ctx => ctx.hour === 22 },
      { prefix: "23ì‹œì˜ ", condition: ctx => ctx.hour === 23 },

      // ìš”ì¼
      { prefix: "ì¼ìš”ì¼ì˜ ", condition: ctx => ctx.weekday === 0 },
      { prefix: "ì›”ìš”ì¼ì˜ ", condition: ctx => ctx.weekday === 1 },
      { prefix: "í™”ìš”ì¼ì˜ ", condition: ctx => ctx.weekday === 2 },
      { prefix: "ìˆ˜ìš”ì¼ì˜ ", condition: ctx => ctx.weekday === 3 },
      { prefix: "ëª©ìš”ì¼ì˜ ", condition: ctx => ctx.weekday === 4 },
      { prefix: "ê¸ˆìš”ì¼ì˜ ", condition: ctx => ctx.weekday === 5 },
      { prefix: "í† ìš”ì¼ì˜ ", condition: ctx => ctx.weekday === 6 },

      // ìœ ì… ê²½ë¡œ
      { prefix: "êµ¬ê¸€ëŸ¬ì˜ ", condition: ctx => ctx.referrer.includes("google") },
      { prefix: "ë„¤ì´ë²„ì˜ ", condition: ctx => ctx.referrer.includes("naver") },

      // 5,10,15ë¶„ë§Œì— ë‹¤ì‹œ ë½‘ê¸°
      { prefix: "5ë¶„ë§Œì—ë‹¤ì‹œë½‘ì€ ", condition: ctx => ctx.timeSinceLastDraw >= 5*60*1000 && ctx.timeSinceLastDraw < 10*60*1000 },
      { prefix: "10ë¶„ë§Œì—ë‹¤ì‹œë½‘ì€ ", condition: ctx => ctx.timeSinceLastDraw >= 10*60*1000 && ctx.timeSinceLastDraw < 15*60*1000 },
      { prefix: "15ë¶„ë§Œì—ë‹¤ì‹œë½‘ì€ ", condition: ctx => ctx.timeSinceLastDraw >= 15*60*1000 },

      // í™”ë©´ ì¼œì§„ ì‹œê°„ (10ë¶„ ë‹¨ìœ„, ë†’ì€ ì‹œê°„ ìš°ì„ )
      { prefix: "50ë¶„ì´ìƒì¼  ", condition: ctx => ctx.screenTime >= 50*60*1000 },
      { prefix: "40ë¶„ì´ìƒì¼  ", condition: ctx => ctx.screenTime >= 40*60*1000 && ctx.screenTime < 50*60*1000 },
      { prefix: "30ë¶„ì´ìƒì¼  ", condition: ctx => ctx.screenTime >= 30*60*1000 && ctx.screenTime < 40*60*1000 },
      { prefix: "20ë¶„ì´ìƒì¼  ", condition: ctx => ctx.screenTime >= 20*60*1000 && ctx.screenTime < 30*60*1000 },
      { prefix: "10ë¶„ì´ìƒì¼  ", condition: ctx => ctx.screenTime >= 10*60*1000 && ctx.screenTime < 20*60*1000 },

      // í”Œë«í¼
      { prefix: "ìœˆë„ìš°ì˜ ", condition: ctx => ctx.platform === "Windows" },
      { prefix: "ì•ˆë“œë¡œì´ë“œì˜ ", condition: ctx => ctx.platform === "Android" },
      { prefix: "iOSì˜ ", condition: ctx => ctx.platform === "iOS" },

      // ê·¸ëƒ¥ (ì‹œë®¬ë ˆì´ì…˜ ê³ ì •ê°’)
      { prefix: "ë§¤ìš°ì„±ëŠ¥ì¢‹ì€ ", condition: ctx => ctx.brightness === "max" },
    ];

    // ëœë¤ ì•„ì´í…œ ë½‘ê¸° í•¨ìˆ˜
    function getRandomItem() {
      const rand = Math.random();
      let cumulative = 0;
      for (const [rarity, rate] of Object.entries(rarityRates)) {
        cumulative += rate;
        if (rand <= cumulative) {
          const filtered = items.filter(i => i.rarity === rarity);
          return filtered[Math.floor(Math.random() * filtered.length)];
        }
      }
      return items[0]; // ê¸°ë³¸ê°’
    }

    // ë°°í„°ë¦¬ ìƒíƒœ ë¹„ë™ê¸° íšë“ í•¨ìˆ˜
    async function getBatteryLevel() {
      if (navigator.getBattery) {
        try {
          const battery = await navigator.getBattery();
          return Math.floor(battery.level * 100);
        } catch {
          return 100; // ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ 100%
        }
      }
      return 100; // ì§€ì› ì•ˆ í•  ê²½ìš° ê¸°ë³¸ 100%
    }

    // ì»¨í…ìŠ¤íŠ¸ ë¹„ë™ê¸° í•¨ìˆ˜
    async function getContext() {
      const now = Date.now();
      const date = new Date();
      const ua = navigator.userAgent.toLowerCase();

      let platform = "Unknown";
      if (ua.includes("windows")) platform = "Windows";
      else if (ua.includes("android")) platform = "Android";
      else if (/iphone|ipad|ipod/.test(ua)) platform = "iOS";

      const battery = await getBatteryLevel();

      return {
        battery,
        seconds: date.getSeconds(),
        minute: date.getMinutes(),
        hour: date.getHours(),
        weekday: date.getDay(),
        brightness: "max", // ì‹œë®¬ë ˆì´ì…˜
        pullCount,
        referrer: document.referrer.toLowerCase(),
        bluetoothConnected: false, // ì‹œë®¬ë ˆì´ì…˜
        platform,
        weather: "clear", // ì‹œë®¬ë ˆì´ì…˜
        screenTime: now - screenStartTime,
        timeSinceLastDraw: now - lastDrawTime
      };
    }

    // ì ‘ë‘ì‚¬ ìƒì„± í•¨ìˆ˜
    function generatePrefix(ctx) {
      let prefix = "";
      for (const cond of prefixConditions) {
        if (cond.condition(ctx) && Math.random() < 0.025) {
          prefix += cond.prefix;
        }
      }
      return prefix;
    }

    // í•©ì„± ë“±ê¸‰ ê²°ì • í•¨ìˆ˜
    function getEnhancementLevel(hasPrefix) {
      const rates = hasPrefix ? enhancementRates.prefix : enhancementRates.normal;
      const rand = Math.random();
      let cumulative = 0;
      
      for (const [level, rate] of Object.entries(rates)) {
        cumulative += rate;
        if (rand <= cumulative) {
          return level;
        }
      }
      return hasPrefix ? 'super' : 'great'; // ê¸°ë³¸ê°’
    }

    // ì•„ì´í…œ ê°€ê²© ê³„ì‚° í•¨ìˆ˜
function calculateItemPrice(item) {
  let basePrice = rarityPrices[item.rarity] || 20;

  // ì ‘ë‘ì‚¬ ê°œìˆ˜ì— ë”°ë¼ ë°°ìœ¨ ì ìš© (10^ê°œìˆ˜)
  if (item.prefix && item.prefix.trim() !== '') {
    const prefixCount = item.prefix.trim().split(/\s+/).filter(p => p !== '').length;
    basePrice *= Math.pow(10, prefixCount);
  }

  // í•©ì„± ë“±ê¸‰ ë°°ìœ¨ ì ìš©
  if (item.enhancement) {
    basePrice *= enhancementMultipliers[item.enhancement];
  }

  return Math.floor(basePrice);
}

    // ì•„ì´í…œ í‘œì‹œ ì´ë¦„ ìƒì„± í•¨ìˆ˜
    function getItemDisplayName(item) {
      let name = "";
      
      if (item.enhancement) {
        const enhancementNames = {
          great: "ê·¸ë˜ì´íŠ¸",
          super: "ìŠˆí¼",
          mega: "ë©”ê°€",
          ultra: "ìš¸íŠ¸ë¼",
          secret: "ì‹œí¬ë¦¿",
          ultimate: "ì–¼í‹°ë©”ì´íŠ¸"
        };
        name += `[${enhancementNames[item.enhancement]}] `;
      }
      
      if (item.prefix && item.prefix.trim() !== '') {
        name += item.prefix;
      }
      
      name += item.name;
      
      return name;
    }

    // í•©ì„± ê°€ëŠ¥í•œ ì•„ì´í…œì¸ì§€ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
    function canCombineItems(item1, item2) {
      if (!item1 || !item2) return false;
      if (item1.rarity !== item2.rarity) return false;
      
      // ì ‘ë‘ì‚¬ í™•ì¸
      const prefix1 = item1.prefix || '';
      const prefix2 = item2.prefix || '';
      
      if (prefix1 !== prefix2) return false;
      
      return true;
    }

    // ì„ íƒëœ ì•„ì´í…œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateSelectedItems() {
      if (selectedItems.length === 0) {
        selectedItemsElem.textContent = "ì„ íƒëœ ì•„ì´í…œ: ì—†ìŒ";
        combineBtn.disabled = true;
      } else if (selectedItems.length === 1) {
        const item = inventory[selectedItems[0]];
        selectedItemsElem.innerHTML = `ì„ íƒëœ ì•„ì´í…œ: ${getItemDisplayName(item)} [${item.rarity}]`;
        combineBtn.disabled = true;
      } else if (selectedItems.length === 2) {
        const item1 = inventory[selectedItems[0]];
        const item2 = inventory[selectedItems[1]];
        selectedItemsElem.innerHTML = `ì„ íƒëœ ì•„ì´í…œ: ${getItemDisplayName(item1)} [${item1.rarity}] + ${getItemDisplayName(item2)} [${item2.rarity}]`;
        combineBtn.disabled = !canCombineItems(item1, item2);
        
        if (!canCombineItems(item1, item2)) {
          selectedItemsElem.innerHTML += " <span style='color: #ff4444;'>(í•©ì„± ë¶ˆê°€)</span>";
        }
      }
    }

auth.onAuthStateChanged(user => {
  if (user) {
    userStatus.textContent = `ë¡œê·¸ì¸ ì¤‘: ${user.displayName || user.email}`;
    loginBtn.style.display = "none";
    logoutBtn.style.display = "inline-block";
    drawBtn.disabled = false;
    inventorySection.style.display = "block";

    // Firestoreì— ì‚¬ìš©ì ì •ë³´ ì¶”ê°€
    const userRef = db.collection("users").doc(user.uid);
    userRef.get().then(doc => {
      if (!doc.exists) {
        userRef.set({
          name: user.displayName || "ìµëª…",
          email: user.email || "",
          gold: totalMoney,
          inventory: inventory
        });
      }
    });

    renderInventory();
    startCooldownTimer();
  } else {
    userStatus.textContent = "ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.";
    loginBtn.style.display = "inline-block";
    logoutBtn.style.display = "none";
    drawBtn.disabled = true;
    inventorySection.style.display = "none";
  }
});


    // ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­
    loginBtn.onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(e => {
        alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + e.message);
      });
    };

    // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í´ë¦­
    logoutBtn.onclick = () => {
      auth.signOut();
    };

    // ì¸ë²¤í† ë¦¬ ë Œë”ë§
    function renderInventory() {
      inventoryList.innerHTML = "";
      // selectedItems = []; // ì´ ì¤„ì„ ì œê±°! ì„ íƒ ìƒíƒœë¥¼ ìœ ì§€í•´ì•¼ í•¨
      updateSelectedItems();
      
      if (inventory.length === 0) {
        inventoryList.innerHTML = "<li>ì¸ë²¤í† ë¦¬ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</li>";
      } else {
        inventory.forEach((item, idx) => {
          const li = document.createElement("li");
          
          const itemInfo = document.createElement("div");
          itemInfo.className = "item-info";
          
          let displayName = getItemDisplayName(item);
          let priceInfo = ` (${calculateItemPrice(item)} ê³¨ë“œ)`;
          
          // í•©ì„± ë“±ê¸‰ë³„ ìƒ‰ìƒ ì ìš©
          if (item.enhancement) {
            itemInfo.innerHTML = `<span class="enhancement-${item.enhancement}">${displayName}</span> [${item.rarity}]${priceInfo}`;
          } else {
            itemInfo.innerHTML = `${displayName} [${item.rarity}]${priceInfo}`;
          }
          
          const buttonDiv = document.createElement("div");
          buttonDiv.className = "item-buttons";
          
          const selectBtn = document.createElement("button");
          selectBtn.textContent = "ì„ íƒ";
          selectBtn.className = "select-btn";
          selectBtn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            selectItem(idx);
          });
          
          const sellBtn = document.createElement("button");
          sellBtn.textContent = "íŒë§¤";
          sellBtn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            sellItem(idx);
          });
          
          buttonDiv.appendChild(selectBtn);
          buttonDiv.appendChild(sellBtn);
          
          li.appendChild(itemInfo);
          li.appendChild(buttonDiv);
          
          // ì„ íƒëœ ì•„ì´í…œ í‘œì‹œ
          if (selectedItems.includes(idx)) {
            li.classList.add("selected");
            selectBtn.textContent = "ì„ íƒí•´ì œ";
            selectBtn.classList.add("selected");
          }
          
          inventoryList.appendChild(li);
        });
      }
      totalMoneyElem.textContent = `ë³´ìœ  ê¸ˆì•¡: ${totalMoney} ê³¨ë“œ`;
    }

    // ì•„ì´í…œ ì„ íƒ/í•´ì œ í•¨ìˆ˜
    function selectItem(idx) {
      console.log("ì„ íƒ í•¨ìˆ˜ í˜¸ì¶œë¨, ì¸ë±ìŠ¤:", idx); // ë””ë²„ê¹…ìš©
      
      const itemIndex = selectedItems.indexOf(idx);
      
      if (itemIndex > -1) {
        // ì´ë¯¸ ì„ íƒëœ ì•„ì´í…œì´ë©´ í•´ì œ
        selectedItems.splice(itemIndex, 1);
        console.log("ì•„ì´í…œ ì„ íƒ í•´ì œ:", idx);
      } else {
        // ìƒˆë¡œ ì„ íƒí•˜ëŠ” ê²½ìš°
        if (selectedItems.length >= 2) {
          alert("ìµœëŒ€ 2ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
          return;
        }
        selectedItems.push(idx);
        console.log("ì•„ì´í…œ ì„ íƒ:", idx);
      }
      
      console.log("í˜„ì¬ ì„ íƒëœ ì•„ì´í…œë“¤:", selectedItems);
      
      // renderInventory í˜¸ì¶œí•˜ì§€ ë§ê³  ì§ì ‘ UIë§Œ ì—…ë°ì´íŠ¸
      updateInventorySelection();
      updateSelectedItems();
    }

    // ì¸ë²¤í† ë¦¬ ì„ íƒ ìƒíƒœë§Œ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
    function updateInventorySelection() {
      const listItems = inventoryList.children;
      for (let i = 0; i < listItems.length; i++) {
        const li = listItems[i];
        const selectBtn = li.querySelector('.select-btn');
        
        if (selectedItems.includes(i)) {
          li.classList.add("selected");
          if (selectBtn) {
            selectBtn.textContent = "ì„ íƒí•´ì œ";
            selectBtn.classList.add("selected");
          }
        } else {
          li.classList.remove("selected");
          if (selectBtn) {
            selectBtn.textContent = "ì„ íƒ";
            selectBtn.classList.remove("selected");
          }
        }
      }
    }

    // ì•„ì´í…œ íŒë§¤ í•¨ìˆ˜
    function sellItem(idx) {
      const item = inventory[idx];
      if (!item) return;
      
      const price = calculateItemPrice(item);
      totalMoney += price;
      
      // ì„ íƒëœ ì•„ì´í…œ ëª©ë¡ì—ì„œ ì œê±°
      const selectedIndex = selectedItems.indexOf(idx);
      if (selectedIndex > -1) {
        selectedItems.splice(selectedIndex, 1);
      }
      
      // ì¸ë±ìŠ¤ ì¡°ì • (ì‚­ì œëœ ì•„ì´í…œë³´ë‹¤ ë’¤ì— ìˆëŠ” ì„ íƒëœ ì•„ì´í…œë“¤ì˜ ì¸ë±ìŠ¤ë¥¼ 1ì”© ê°ì†Œ)
      selectedItems = selectedItems.map(selectedIdx => selectedIdx > idx ? selectedIdx - 1 : selectedIdx);
      
      inventory.splice(idx, 1);
      localStorage.setItem("inventory", JSON.stringify(inventory));
      localStorage.setItem("totalMoney", totalMoney);
      renderInventory();
      updateSelectedItems();
      alert(`${getItemDisplayName(item)}ì„(ë¥¼) ${price} ê³¨ë“œì— íŒë§¤í–ˆìŠµë‹ˆë‹¤.`);
    }

    // í•©ì„±í•˜ê¸° í•¨ìˆ˜
    function combineItems() {
      if (selectedItems.length !== 2) {
        alert("í•©ì„±í•˜ë ¤ë©´ ì •í™•íˆ 2ê°œì˜ ì•„ì´í…œì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.");
        return;
      }
      
      const item1 = inventory[selectedItems[0]];
      const item2 = inventory[selectedItems[1]];
      
      if (!canCombineItems(item1, item2)) {
        alert("ì„ íƒí•œ ì•„ì´í…œë“¤ì€ í•©ì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ê°™ì€ ë“±ê¸‰ & ê°™ì€ ì ‘ë‘ì‚¬ì—¬ì•¼ í•¨)");
        return;
      }
      
      // ì ‘ë‘ì‚¬ ì—¬ë¶€ í™•ì¸
      const hasPrefix = (item1.prefix && item1.prefix.trim() !== '') || (item2.prefix && item2.prefix.trim() !== '');
      
      // í•©ì„± ë“±ê¸‰ ê²°ì •
      const enhancementLevel = getEnhancementLevel(hasPrefix);
      
      // ìƒˆë¡œìš´ ì•„ì´í…œ ìƒì„± (ì²« ë²ˆì§¸ ì•„ì´í…œì„ ë² ì´ìŠ¤ë¡œ)
      const newItem = {
        ...item1,
        enhancement: enhancementLevel
      };
      
      // ê¸°ì¡´ ì•„ì´í…œë“¤ ì œê±° (ì¸ë±ìŠ¤ê°€ í° ê²ƒë¶€í„° ì œê±°)
      const sortedIndices = selectedItems.sort((a, b) => b - a);
      for (const idx of sortedIndices) {
        inventory.splice(idx, 1);
      }
      
      // ìƒˆ ì•„ì´í…œ ì¶”ê°€
      inventory.push(newItem);
      
      // ì €ì¥
      localStorage.setItem("inventory", JSON.stringify(inventory));
      
      // ì„ íƒ ì´ˆê¸°í™”
      selectedItems = [];
      
      // UI ì—…ë°ì´íŠ¸
      renderInventory();
      updateSelectedItems();
      
      const enhancementNames = {
        great: "ê·¸ë˜ì´íŠ¸",
        super: "ìŠˆí¼", 
        mega: "ë©”ê°€",
        ultra: "ìš¸íŠ¸ë¼",
        secret: "ì‹œí¬ë¦¿",
        ultimate: "ì–¼í‹°ë©”ì´íŠ¸"
      };
      
      alert(`í•©ì„± ì„±ê³µ! ${enhancementNames[enhancementLevel]} ë“±ê¸‰ì˜ ${getItemDisplayName(newItem)}ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`);
    }

    // ì„ íƒ ì´ˆê¸°í™” í•¨ìˆ˜
    function clearSelection() {
      selectedItems = [];
      updateInventorySelection();
      updateSelectedItems();
      console.log("ì„ íƒ ì´ˆê¸°í™”ë¨");
    }

    // ì¿¨ë‹¤ìš´ ë° ë½‘ê¸° ë²„íŠ¼ ê´€ë¦¬
    function startCooldownTimer() {
      const COOLDOWN_MS = 5000; // 5ì´ˆ
      let intervalId = null;

      function update() {
        const now = Date.now();
        const diff = COOLDOWN_MS - (now - lastDrawTime);

        if (diff > 0) {
          drawBtn.disabled = true;
          if (!document.getElementById("cooldownTimer")) {
            const timerElem = document.createElement("div");
            timerElem.id = "cooldownTimer";
            timerElem.style.color = "#aad";
            timerElem.style.marginTop = "10px";
            drawBtn.after(timerElem);
          }
          document.getElementById("cooldownTimer").textContent = `ë½‘ê¸° ì¿¨ë‹¤ìš´: ${(diff / 1000).toFixed(1)}ì´ˆ ë‚¨ìŒ`;
        } else {
          drawBtn.disabled = false;
          const timerElem = document.getElementById("cooldownTimer");
          if (timerElem) timerElem.textContent = "";
        }
      }

      update();
      intervalId = setInterval(update, 100);

      return () => clearInterval(intervalId);
    }

    // ì´ˆê¸° ì¿¨ë‹¤ìš´ íƒ€ì´ë¨¸ ì‹œì‘
    let stopCooldown = startCooldownTimer();

    // ë½‘ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
drawBtn.addEventListener("click", async () => {
  if (drawBtn.disabled) return;

  // ì¸ë²¤í† ë¦¬ 25ê°œ ì œí•œ ì²´í¬
  if (inventory.length >= 10) {
    alert("ì¸ë²¤í† ë¦¬ê°€ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤! (ìµœëŒ€ 10ê°œ)");
    return;
  }

  const ctx = await getContext();

  pullCount++;
  lastDrawTime = Date.now();
  localStorage.setItem("pullCount", pullCount);
  localStorage.setItem("lastDrawTime", lastDrawTime);

  const item = getRandomItem();
  const prefix = generatePrefix(ctx);
  const fullName = prefix + item.name;

  // ì¸ë²¤í† ë¦¬ì— ì €ì¥
  const inventoryItem = { ...item, prefix };
  inventory.push(inventoryItem);
  localStorage.setItem("inventory", JSON.stringify(inventory));

  document.getElementById("result").textContent = `ë½‘ì€ ì•„ì´í…œ: ${fullName} [${item.rarity}]`;

  renderInventory();

  // Firebase ê¸°ë¡ ì €ì¥ (ë¡œê·¸ì¸ ì‹œë§Œ)
  const user = auth.currentUser;
  if (user) {
    try {
      await db.collection("pulls").add({
        userId: user.uid,
        userName: user.displayName,
        item: fullName,
        rarity: item.rarity,
        context: ctx,
        timestamp: new Date()
      });
    } catch (e) {
      console.error("Firebase ì €ì¥ ì‹¤íŒ¨:", e);
    }
  }

  // ì¿¨ë‹¤ìš´ ë‹¤ì‹œ ì‹œì‘
  stopCooldown();
  stopCooldown = startCooldownTimer();
});

    // í•©ì„± ë²„íŠ¼ ì´ë²¤íŠ¸
    combineBtn.addEventListener("click", combineItems);

    // ì„ íƒ ì´ˆê¸°í™” ë²„íŠ¼ ì´ë²¤íŠ¸
    clearSelectionBtn.addEventListener("click", clearSelection);
    let marketListings = JSON.parse(localStorage.getItem("marketListings")) || [];
let myListings = JSON.parse(localStorage.getItem("myListings")) || [];
let gold = JSON.parse(localStorage.getItem("gold")) || 1000; // ìœ ì € ëˆ

// ì£¼ì‹ì¥ í˜ì´ì§€ ë Œë”ë§
async function renderMarket() {
  const marketDiv = document.getElementById("marketListings");
  const myDiv = document.getElementById("myListings");
  const inventoryDiv = document.getElementById("inventoryForMarket");

  marketDiv.innerHTML = "";
  myDiv.innerHTML = "";
  inventoryDiv.innerHTML = "";

  const user = auth.currentUser;
  if (!user) {
    myDiv.innerHTML = "<p>ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>";
    return;
  }

  // ê²€ìƒ‰ & í•„í„° ê°’
  const searchValue = document.getElementById("marketSearch").value.toLowerCase();
  const filterPrefix = document.getElementById("filterPrefix").checked;
  const filterRarity = document.getElementById("filterRarity").checked;
  const filterEnhancement = document.getElementById("filterEnhancement").checked;

  // ë‚´ ì¸ë²¤í† ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
  const userSnap = await db.ref(`users/${user.uid}`).once("value");
  const userData = userSnap.val() || {};
  const inventoryData = userData.inventory || [];
  const myGold = userData.gold || 0;

  // ğŸ”¹ ë‚´ ìƒí’ˆ ë Œë”ë§
  const myListingsSnap = await db.ref("market/listings").orderByChild("seller").equalTo(user.uid).once("value");
  myListingsSnap.forEach(child => {
    const listing = child.val();
    const div = document.createElement("div");
    div.textContent = `${getItemDisplayName(listing.item)} - ${listing.price}ê³¨ë“œ`;

    const withdrawBtn = document.createElement("button");
    withdrawBtn.textContent = "íšŒìˆ˜";
    withdrawBtn.onclick = () => withdrawListing(child.key, listing);

    div.appendChild(withdrawBtn);
    myDiv.appendChild(div);
  });

  // ğŸ”¹ ë“±ë¡ ê°€ëŠ¥í•œ ì¸ë²¤í† ë¦¬ í‘œì‹œ
  inventoryData.forEach((item, idx) => {
    const div = document.createElement("div");
    div.textContent = `${getItemDisplayName(item)} (ê¸°ë³¸ê°€: ${calculateItemPrice(item)}ê³¨ë“œ)`;

    const suggested = getSuggestedPrice(item);
    const priceInput = document.createElement("input");
    priceInput.type = "number";
    priceInput.min = Math.floor(calculateItemPrice(item) * 0.15);
    priceInput.max = Math.floor(calculateItemPrice(item) * 150);
    priceInput.value = suggested;

    const registerBtn = document.createElement("button");
    registerBtn.textContent = "ë“±ë¡";
    registerBtn.onclick = () => {
      const price = parseInt(priceInput.value, 10);
      if (price < priceInput.min || price > priceInput.max) {
        alert(`ê°€ê²©ì€ ${priceInput.min} ~ ${priceInput.max} ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.`);
        return;
      }
      registerItemToMarket(item, idx, price);
    };

    div.appendChild(document.createTextNode(` â†’ ì˜ˆìƒê°€ ${suggested}ê³¨ë“œ`));
    div.appendChild(priceInput);
    div.appendChild(registerBtn);

    inventoryDiv.appendChild(div);
  });

  // ğŸ”¹ ì „ì²´ ì‹œì¥ ìƒí’ˆ ë¶ˆëŸ¬ì˜¤ê¸°
  let listingsSnap = await db.ref("market/listings").once("value");
  let listings = [];
  listingsSnap.forEach(child => {
    listings.push({ id: child.key, ...child.val() });
  });

  // ê²€ìƒ‰ & í•„í„° ì ìš©
  if (searchValue) {
    listings = listings.filter(l =>
      l.item.name.toLowerCase().includes(searchValue) ||
      (l.item.prefix && l.item.prefix.toLowerCase().includes(searchValue))
    );
  }
  if (filterPrefix) {
    listings = listings.filter(l => l.item.prefix);
  }
  if (filterRarity) {
    listings.sort((a, b) => (rarityPrices[b.item.rarity] || 0) - (rarityPrices[a.item.rarity] || 0));
  }
  if (filterEnhancement) {
    listings.sort((a, b) => (enhancementMultipliers[b.item.enhancement] || 1) - (enhancementMultipliers[a.item.enhancement] || 1));
  }

  // ğŸ”¹ ì „ì²´ ìƒí’ˆ ë Œë”ë§
  listings.forEach(listing => {
    const div = document.createElement("div");
    div.textContent = `${getItemDisplayName(listing.item)} - ${listing.price}ê³¨ë“œ`;

    if (listing.seller !== user.uid) {
      const buyBtn = document.createElement("button");
      buyBtn.textContent = "êµ¬ë§¤";
      buyBtn.onclick = () => buyListing(listing);
      div.appendChild(buyBtn);
    } else {
      div.appendChild(document.createTextNode(" (ë‚´ ë¬¼ê±´)"));
    }

    marketDiv.appendChild(div);
  });
}

// ì•„ì´í…œ ë“±ë¡
async function registerItemToMarket(item, index, price) {
  const user = auth.currentUser;
  if (!user) return alert("ë¡œê·¸ì¸ í•„ìš”");

  const myListingsSnap = await db.ref("market/listings").orderByChild("seller").equalTo(user.uid).once("value");
  if (myListingsSnap.numChildren() >= 3) {
    return alert("ìµœëŒ€ 3ê°œê¹Œì§€ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤!");
  }

  const newListingRef = db.ref("market/listings").push();
  await newListingRef.set({
    seller: user.uid,
    item,
    price
  });

  // ì¸ë²¤í† ë¦¬ì—ì„œ ì œê±°
  const invRef = db.ref(`users/${user.uid}/inventory`);
  const invSnap = await invRef.once("value");
  let invArr = invSnap.val() || [];
  invArr.splice(index, 1);
  await invRef.set(invArr);

  renderMarket();
  renderInventory();
}

// íšŒìˆ˜
async function withdrawListing(listingId, listing) {
  const user = auth.currentUser;
  if (!user) return;

  await db.ref(`market/listings/${listingId}`).remove();

  // ë‹¤ì‹œ ì¸ë²¤í† ë¦¬ì— ë³µêµ¬
  const invRef = db.ref(`users/${user.uid}/inventory`);
  const invSnap = await invRef.once("value");
  let invArr = invSnap.val() || [];
  invArr.push(listing.item);
  await invRef.set(invArr);

  renderMarket();
  renderInventory();
}

// êµ¬ë§¤
async function buyListing(listing) {
  const user = auth.currentUser;
  if (!user) return;

  const buyerRef = db.ref(`users/${user.uid}`);
  const buyerSnap = await buyerRef.once("value");
  const buyerData = buyerSnap.val() || {};
  let buyerGold = buyerData.gold || 0;

  if (buyerGold < listing.price) {
    return alert("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!");
  }

  // êµ¬ë§¤ì ê³¨ë“œ ì°¨ê°
  buyerGold -= listing.price;
  let buyerInv = buyerData.inventory || [];
  buyerInv.push(listing.item);

  await buyerRef.update({ gold: buyerGold, inventory: buyerInv });

  // íŒë§¤ì ê³¨ë“œ ì§€ê¸‰
  if (listing.seller) {
    const sellerRef = db.ref(`users/${listing.seller}`);
    const sellerSnap = await sellerRef.once("value");
    const sellerData = sellerSnap.val() || {};
    let sellerGold = sellerData.gold || 0;
    sellerGold += listing.price;
    await sellerRef.update({ gold: sellerGold });
  }

  // ì‹œì¥ì—ì„œ ì œê±°
  await db.ref(`market/listings/${listing.id}`).remove();

  renderMarket();
  renderInventory();
}

// ì˜ˆìƒ ê¸ˆì•¡ ê³„ì‚°
function getSuggestedPrice(item) {
  return Math.floor(calculateItemPrice(item) * 1.1);
}

// ì´ë²¤íŠ¸ ë“±ë¡
document.getElementById("marketSearch").addEventListener("input", renderMarket);
document.getElementById("filterPrefix").addEventListener("change", renderMarket);
document.getElementById("filterRarity").addEventListener("change", renderMarket);
document.getElementById("filterEnhancement").addEventListener("change", renderMarket);

document.getElementById("marketBtn").addEventListener("click", () => {
  document.getElementById("marketPage").style.display = "block";
  renderMarket();
});

  </script>

</body>
</html>
